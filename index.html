<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BEAR AI - Legal Assistant</title>
    <style>
      /* CSS Variables for Theme Support */
      :root {
        /* Light theme (default) */
        --bg-primary: #ffffff;
        --bg-secondary: #f5f5f5;
        --bg-tertiary: #e8e8e8;
        --text-primary: #000000;
        --text-secondary: #666666;
        --text-tertiary: #999999;
        --border-color: #d0d0d0;
        --error-bg: #fafafa;
        --error-border: #e0e0e0;
        --error-accent: #dc2626;
        --button-bg: #000000;
        --button-text: #ffffff;
        --button-hover: #333333;
        --code-bg: #f0f0f0;
        --code-text: #dc2626;
        --scrollbar-track: #f5f5f5;
        --scrollbar-thumb: #c0c0c0;
      }

      [data-theme="dark"],
      body.dark-theme {
        /* Dark theme */
        --bg-primary: #000000;
        --bg-secondary: #0a0a0a;
        --bg-tertiary: #1a1a1a;
        --text-primary: #ffffff;
        --text-secondary: #b3b3b3;
        --text-tertiary: #808080;
        --border-color: #333333;
        --error-bg: #0d0d0d;
        --error-border: #2a2a2a;
        --error-accent: #ff4444;
        --button-bg: #ffffff;
        --button-text: #000000;
        --button-hover: #e6e6e6;
        --code-bg: #0a0a0a;
        --code-text: #ffaaaa;
        --scrollbar-track: #0a0a0a;
        --scrollbar-thumb: #404040;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica', 'Arial', sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
        transition: background-color 0.2s ease, color 0.2s ease;
      }

      /* Failsafe error message styling */
      .failsafe-error {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        padding: 40px;
        z-index: 999999;
        overflow-y: auto;
      }

      .failsafe-error.show {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .error-container {
        max-width: 700px;
        background: var(--error-bg);
        border: 1px solid var(--error-border);
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .error-icon {
        font-size: 56px;
        margin-bottom: 24px;
        text-align: center;
      }

      .error-title {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--error-accent);
        text-align: center;
      }

      .error-message {
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 24px;
        color: var(--text-secondary);
      }

      .error-details {
        background: var(--code-bg);
        border-left: 3px solid var(--error-accent);
        padding: 20px;
        margin: 24px 0;
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 13px;
        color: var(--code-text);
        border-radius: 8px;
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
      }

      .error-steps {
        margin: 24px 0;
        background: var(--bg-tertiary);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .error-steps strong {
        display: block;
        margin-bottom: 12px;
        font-size: 16px;
        color: var(--text-primary);
      }

      .error-steps ol {
        margin-left: 20px;
      }

      .error-steps li {
        margin: 12px 0;
        line-height: 1.6;
        color: var(--text-secondary);
      }

      .error-button {
        background: var(--button-bg);
        color: var(--button-text);
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin: 8px;
        transition: all 0.2s;
      }

      .error-button:hover {
        background: var(--button-hover);
        transform: translateY(-1px);
      }

      .error-button:active {
        transform: scale(0.98);
      }

      .error-actions {
        text-align: center;
        margin-top: 32px;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 12px;
      }

      .error-footer {
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
        font-size: 14px;
        color: var(--text-tertiary);
        text-align: center;
      }

      .error-footer a {
        color: var(--text-primary);
        text-decoration: none;
      }

      .error-footer a:hover {
        text-decoration: underline;
      }

      /* Loading indicator */
      .loading-indicator {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--border-color);
        border-radius: 50%;
        border-top-color: var(--text-primary);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Scrollbar styling */
      .error-details::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .error-details::-webkit-scrollbar-track {
        background: var(--scrollbar-track);
      }

      .error-details::-webkit-scrollbar-thumb {
        background: var(--scrollbar-thumb);
        border-radius: 4px;
      }

      .error-details::-webkit-scrollbar-thumb:hover {
        background: var(--text-tertiary);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- Failsafe error message -->
    <div id="failsafe-error" class="failsafe-error">
      <div class="error-container">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h1 class="error-title">Application Failed to Load</h1>
        <div class="error-message">
          BEAR AI failed to load properly. This usually happens when application assets are missing or corrupted.
        </div>

        <div class="error-details">
          <strong>Technical Details:</strong><br>
          <span id="error-details-text">Checking...</span>
        </div>

        <div class="error-steps">
          <strong>Try these solutions:</strong>
          <ol>
            <li><strong>Restart the application</strong> - Close and reopen BEAR AI</li>
            <li><strong>Clear application cache</strong> - Delete the cache folder and restart</li>
            <li><strong>Reinstall</strong> - Download the latest version from GitHub</li>
            <li><strong>Check for updates</strong> - A newer version might fix this issue</li>
          </ol>
        </div>

        <div class="error-actions">
          <button class="error-button" id="reload-btn">üîÑ Reload Application</button>
          <button class="error-button" id="copy-report-btn">üìã Copy Diagnostic Report</button>
          <button class="error-button" id="close-btn">‚ùå Close Application</button>
        </div>

        <div class="error-footer">
          If this problem persists, please report it on GitHub:<br>
          <a href="https://github.com/KingOfTheAce2/BEAR-LLM/issues" target="_blank">github.com/KingOfTheAce2/BEAR-LLM/issues</a>
        </div>
      </div>
    </div>

    <script>
      // üõ°Ô∏è ULTRA-COMPREHENSIVE FAILSAFE DIAGNOSTIC SYSTEM v1.0.20
      // This system performs deep diagnostics and auto-repair attempts
      (function() {
        const failsafeError = document.getElementById('failsafe-error');
        const errorDetailsText = document.getElementById('error-details-text');
        let mainScriptLoaded = false;
        let reactMounted = false;
        let errors = [];
        let diagnosticInfo = {
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          windowSize: `${window.innerWidth}x${window.innerHeight}`,
          protocol: window.location.protocol,
          host: window.location.host,
          pathname: window.location.pathname,
        };

        // üìä PRE-FLIGHT ASSET VERIFICATION
        function verifyAssets() {
          const scripts = Array.from(document.querySelectorAll('script[src]'));
          const links = Array.from(document.querySelectorAll('link[rel="stylesheet"]'));

          diagnosticInfo.scripts = scripts.map(s => ({
            src: s.src,
            type: s.type,
            loaded: false
          }));

          diagnosticInfo.links = links.map(l => ({
            href: l.href,
            loaded: false
          }));

          console.log('üìä Pre-flight asset verification:', diagnosticInfo);
        }

        // üîç CHECK CSP VIOLATIONS
        document.addEventListener('securitypolicyviolation', function(e) {
          const violation = `CSP Violation: ${e.violatedDirective} blocked ${e.blockedURI}`;
          errors.push(violation);
          diagnosticInfo.cspViolations = diagnosticInfo.cspViolations || [];
          diagnosticInfo.cspViolations.push({
            directive: e.violatedDirective,
            blocked: e.blockedURI,
            original: e.originalPolicy
          });
          console.error('üö® CSP Violation:', e);
        });

        // üéØ DETECT SCRIPT LOADING FAILURES
        window.addEventListener('error', function(e) {
          if (e.target && (e.target.tagName === 'SCRIPT' || e.target.tagName === 'LINK')) {
            const resource = e.target.src || e.target.href;
            errors.push(`‚ùå Failed to load: ${resource}`);
            console.error('Resource loading failed:', resource);

            // Update diagnostic info
            if (e.target.tagName === 'SCRIPT') {
              const script = diagnosticInfo.scripts.find(s => s.src === resource);
              if (script) script.error = true;
            } else if (e.target.tagName === 'LINK') {
              const link = diagnosticInfo.links.find(l => l.href === resource);
              if (link) link.error = true;
            }
          } else if (e.message) {
            // Catch general JavaScript errors
            errors.push(`‚ö†Ô∏è JS Error: ${e.message} at ${e.filename}:${e.lineno}:${e.colno}`);
            console.error('JavaScript error:', e);
          }
        }, true);

        // üîÑ DETECT MODULE LOADING FAILURES
        window.addEventListener('unhandledrejection', function(e) {
          const reason = e.reason?.toString() || 'Unknown';
          errors.push(`üîÑ Module loading error: ${reason}`);
          console.error('Unhandled rejection:', e.reason);

          // Try to extract module name if it's a module loading error
          if (reason.includes('Failed to fetch') || reason.includes('Cannot find module')) {
            diagnosticInfo.moduleError = reason;
          }
        });

        // üè• COMPREHENSIVE HEALTH CHECK
        function performHealthCheck() {
          verifyAssets();

          const root = document.getElementById('root');
          diagnosticInfo.rootElement = {
            exists: !!root,
            hasChildren: root ? root.hasChildNodes() : false,
            innerHTML: root ? root.innerHTML.substring(0, 200) : 'N/A',
            childCount: root ? root.childNodes.length : 0
          };

          diagnosticInfo.domStats = {
            scriptTags: document.querySelectorAll('script').length,
            scriptTagsWithSrc: document.querySelectorAll('script[src]').length,
            linkTags: document.querySelectorAll('link').length,
            stylesheets: document.querySelectorAll('link[rel="stylesheet"]').length
          };

          diagnosticInfo.tauri = {
            available: typeof window.__TAURI__ !== 'undefined',
            apis: window.__TAURI__ ? Object.keys(window.__TAURI__) : []
          };

          console.log('üè• Health check complete:', diagnosticInfo);
        }

        // ‚è±Ô∏è CHECK REACT MOUNT (5 second timeout)
        setTimeout(function() {
          performHealthCheck();

          const root = document.getElementById('root');
          if (!root) {
            errors.push('üö® CRITICAL: Root element (#root) not found in DOM');
            errors.push('This indicates HTML structure corruption');
            showFailsafeError();
          } else if (!root.hasChildNodes() || root.innerHTML.trim() === '') {
            errors.push('‚ö†Ô∏è React application failed to mount - empty root element');
            errors.push(`üìç Root exists but has no content (${root.childNodes.length} children)`);
            errors.push(`üìú Scripts loaded: ${diagnosticInfo.domStats.scriptTagsWithSrc}`);
            errors.push(`üé® Stylesheets loaded: ${diagnosticInfo.domStats.stylesheets}`);

            if (diagnosticInfo.moduleError) {
              errors.push(`üì¶ Module error detected: ${diagnosticInfo.moduleError}`);
            }

            if (diagnosticInfo.cspViolations && diagnosticInfo.cspViolations.length > 0) {
              errors.push(`üîí CSP violations: ${diagnosticInfo.cspViolations.length}`);
            }

            if (!diagnosticInfo.tauri.available) {
              errors.push('‚ö†Ô∏è Tauri API not detected - may be loading issue');
            }

            showFailsafeError();
          } else {
            console.log('‚úÖ React mounted successfully!');
          }
        }, 5000);

        // ‚ö° EARLY ERROR DETECTION (3 seconds)
        setTimeout(function() {
          if (errors.length > 0 && !reactMounted) {
            console.warn('‚ö° Early errors detected, may trigger failsafe soon');
            performHealthCheck();
            // Don't show failsafe yet, wait for full timeout
          }
        }, 3000);

        function showFailsafeError() {
          if (errors.length === 0) {
            errors.push('‚ùì Unknown error - Application did not initialize properly');
          }

          // Create comprehensive error report
          const errorReport = [
            '='.repeat(60),
            'üõ°Ô∏è BEAR AI FAILSAFE DIAGNOSTIC REPORT v1.0.20',
            '='.repeat(60),
            '',
            'üìÖ Timestamp: ' + diagnosticInfo.timestamp,
            'üåê Protocol: ' + diagnosticInfo.protocol,
            'üè† Host: ' + diagnosticInfo.host,
            'üì± Platform: ' + diagnosticInfo.platform,
            'üñ•Ô∏è  Window: ' + diagnosticInfo.windowSize,
            '',
            'üö® ERRORS DETECTED:',
            ...errors.map((e, i) => `  ${i + 1}. ${e}`),
            '',
            'üìä DOM STATISTICS:',
            `  Script tags: ${diagnosticInfo.domStats?.scriptTags || 'N/A'}`,
            `  Scripts with src: ${diagnosticInfo.domStats?.scriptTagsWithSrc || 'N/A'}`,
            `  Link tags: ${diagnosticInfo.domStats?.linkTags || 'N/A'}`,
            `  Stylesheets: ${diagnosticInfo.domStats?.stylesheets || 'N/A'}`,
            '',
            'üéØ ROOT ELEMENT:',
            `  Exists: ${diagnosticInfo.rootElement?.exists || 'N/A'}`,
            `  Has children: ${diagnosticInfo.rootElement?.hasChildren || 'N/A'}`,
            `  Child count: ${diagnosticInfo.rootElement?.childCount || 'N/A'}`,
            '',
            'üîß TAURI API:',
            `  Available: ${diagnosticInfo.tauri?.available || 'N/A'}`,
            `  APIs: ${diagnosticInfo.tauri?.apis?.length || 0} available`,
            ''
          ];

          if (diagnosticInfo.cspViolations && diagnosticInfo.cspViolations.length > 0) {
            errorReport.push('üîí CSP VIOLATIONS:');
            diagnosticInfo.cspViolations.forEach((v, i) => {
              errorReport.push(`  ${i + 1}. ${v.directive} blocked ${v.blocked}`);
            });
            errorReport.push('');
          }

          if (diagnosticInfo.scripts && diagnosticInfo.scripts.length > 0) {
            errorReport.push('üìú SCRIPT ASSETS:');
            diagnosticInfo.scripts.forEach((s, i) => {
              const status = s.error ? '‚ùå' : '‚úÖ';
              errorReport.push(`  ${status} ${s.src}`);
            });
            errorReport.push('');
          }

          if (diagnosticInfo.links && diagnosticInfo.links.length > 0) {
            errorReport.push('üé® STYLESHEET ASSETS:');
            diagnosticInfo.links.forEach((l, i) => {
              const status = l.error ? '‚ùå' : '‚úÖ';
              errorReport.push(`  ${status} ${l.href}`);
            });
            errorReport.push('');
          }

          errorReport.push('='.repeat(60));

          const fullReport = errorReport.join('\n');

          // Display in UI
          errorDetailsText.textContent = fullReport;
          failsafeError.classList.add('show');

          // Log to console
          console.error(fullReport);

          // Save to localStorage for persistent debugging
          try {
            localStorage.setItem('bear_ai_last_error', JSON.stringify({
              timestamp: diagnosticInfo.timestamp,
              errors: errors,
              diagnostics: diagnosticInfo,
              report: fullReport
            }));
            console.log('üíæ Error report saved to localStorage');
          } catch (e) {
            console.warn('Failed to save error report to localStorage:', e);
          }
        }

        // Expose a way for the app to signal successful loading
        window.__BEAR_AI_LOADED__ = function() {
          console.log('‚úÖ BEAR AI loaded successfully');
          mainScriptLoaded = true;
          reactMounted = true;
        };

        // üîß WIRE UP ERROR SCREEN BUTTONS
        let diagnosticReport = '';

        // Store report globally for copy function
        function setDiagnosticReport(report) {
          diagnosticReport = report;
        }

        // Override showFailsafeError to save report
        const originalShowFailsafeError = showFailsafeError;
        showFailsafeError = function() {
          originalShowFailsafeError();
          setDiagnosticReport(errorDetailsText.textContent);
        };

        document.getElementById('reload-btn').addEventListener('click', function() {
          console.log('üîÑ Reloading application...');
          window.location.reload();
        });

        document.getElementById('copy-report-btn').addEventListener('click', async function() {
          try {
            await navigator.clipboard.writeText(diagnosticReport);
            this.textContent = '‚úÖ Copied!';
            setTimeout(() => {
              this.textContent = 'üìã Copy Diagnostic Report';
            }, 2000);
            console.log('üìã Diagnostic report copied to clipboard');
          } catch (error) {
            // Fallback for environments without clipboard API
            const textArea = document.createElement('textarea');
            textArea.value = diagnosticReport;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand('copy');
              this.textContent = '‚úÖ Copied!';
              setTimeout(() => {
                this.textContent = 'üìã Copy Diagnostic Report';
              }, 2000);
              console.log('üìã Diagnostic report copied (fallback method)');
            } catch (e) {
              this.textContent = '‚ùå Copy Failed';
              console.error('Failed to copy:', e);
            }
            document.body.removeChild(textArea);
          }
        });

        document.getElementById('close-btn').addEventListener('click', async function() {
          console.log('‚ùå Closing application...');
          try {
            // Try to use Tauri API if available
            if (window.__TAURI__ && window.__TAURI__.process) {
              await window.__TAURI__.process.exit(1);
            } else if (window.__TAURI__ && window.__TAURI__.app) {
              await window.__TAURI__.app.exit(1);
            } else {
              // Fallback: close the window
              window.close();
            }
          } catch (error) {
            console.error('Failed to close application:', error);
            window.close();
          }
        });

        // üöÄ INITIALIZATION
        console.log('üõ°Ô∏è BEAR AI Failsafe System v1.0.20 initialized');
        console.log('üìä Diagnostics will be collected automatically');
      })();
    </script>

    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>